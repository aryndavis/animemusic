import os
import sys
import json
from mock import patch
import unittest
sys.path.insert(0, os.path.abspath(".."))
from my_src import read_audio, print_audio_nice, find_audio  # noqa


class TestStuff(unittest.TestCase):
    def testRecordAudio(self):
        pass
    # TODO: need to find out how to patch or mock pyaudio
        # with patch('pyaudio') as p:
        #   assert read_audio() == 'output.wav'

    def testfind_audio(self):
        # TODO: accidentally set this up with requests.get instead of requests.
        # post and need to test for posts
        results = json.loads('{"status":"success","result":{"artist":"Imagine Dragons","title":"Warriors","album":"Warriors","release_date":"2014-09-18","label":"Universal Music","timecode":"00:40","song_link":"https://lis.tn/Warriors","apple_music":{"previews":[{"url":"https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview118/v4/65/07/f5/6507f5c5-dba8-f2d5-d56b-39dbb62a5f60/mzaf_1124211745011045566.plus.aac.p.m4a"}],"artwork":{"width":1500,"height":1500,"url":"https://is2-ssl.mzstatic.com/image/thumb/Music128/v4/f4/78/f5/f478f58e-97cf-83b5-b5da-03d31f14e648/00602547623805.rgb.jpg/{w}x{h}bb.jpeg","bgColor":"7f5516","textColor1":"ffe2aa","textColor2":"f8e0bd","textColor3":"e5c58c","textColor4":"e0c59c"},"artistName":"Imagine Dragons","url":"https://music.apple.com/us/album/warriors/1440831203?app=music\u0026at=1000l33QU\u0026i=1440831624\u0026mt=1","discNumber":1,"genreNames":["Alternative","Music"],"durationInMillis":170799,"releaseDate":"2014-09-18","name":"Warriors","isrc":"USUM71414163","albumName":"Smoke + Mirrors (Deluxe)","playParams":{"id":"1440831624","kind":"song"},"trackNumber":18,"composerName":"Imagine Dragons, Alex Da Kid \u0026 Josh Mosser"},"spotify":{"album":{"album_type":"album","artists":[{"external_urls":{"spotify":"https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"},"href":"https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q","id":"53XhwfbYqKCa1cC15pYq2q","name":"Imagine Dragons","type":"artist","uri":"spotify:artist:53XhwfbYqKCa1cC15pYq2q"}],"available_markets":null,"external_urls":{"spotify":"https://open.spotify.com/album/6ecx4OFG0nlUMqAi9OXQER"},"href":"https://api.spotify.com/v1/albums/6ecx4OFG0nlUMqAi9OXQER","id":"6ecx4OFG0nlUMqAi9OXQER","images":[{"height":640,"url":"https://i.scdn.co/image/ab67616d0000b2731551c93dfa33ea4f30ef4eea","width":640},{"height":300,"url":"https://i.scdn.co/image/ab67616d00001e021551c93dfa33ea4f30ef4eea","width":300},{"height":64,"url":"https://i.scdn.co/image/ab67616d000048511551c93dfa33ea4f30ef4eea","width":64}],"name":"Smoke + Mirrors (Deluxe)","release_date":"2015-10-30","release_date_precision":"day","total_tracks":21,"type":"album","uri":"spotify:album:6ecx4OFG0nlUMqAi9OXQER"},"artists":[{"external_urls":{"spotify":"https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"},"href":"https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q","id":"53XhwfbYqKCa1cC15pYq2q","name":"Imagine Dragons","type":"artist","uri":"spotify:artist:53XhwfbYqKCa1cC15pYq2q"}],"available_markets":null,"disc_number":1,"duration_ms":170066,"explicit":false,"external_ids":{"isrc":"USUM71414163"},"external_urls":{"spotify":"https://open.spotify.com/track/1lgN0A2Vki2FTON5PYq42m"},"href":"https://api.spotify.com/v1/tracks/1lgN0A2Vki2FTON5PYq42m","id":"1lgN0A2Vki2FTON5PYq42m","is_local":false,"name":"Warriors","popularity":68,"preview_url":"","track_number":18,"type":"track","uri":"spotify:track:1lgN0A2Vki2FTON5PYq42m"}}}')  # noqa: E501
        with patch('requests.post') as r_mock:
            r_mock.return_value.content = '{"status": "success", "result": {"artist": "Imagine Dragons", "title": "Warriors", "album": "Warriors", "release_date": "2014-09-18", "label": "Universal Music", "timecode": "00:40", "song_link": "https://lis.tn/Warriors", "apple_music": {"previews": [{"url": "https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview118/v4/65/07/f5/6507f5c5-dba8-f2d5-d56b-39dbb62a5f60/mzaf_1124211745011045566.plus.aac.p.m4a"}], "artwork": {"width": 1500, "height": 1500, "url": "https://is2-ssl.mzstatic.com/image/thumb/Music128/v4/f4/78/f5/f478f58e-97cf-83b5-b5da-03d31f14e648/00602547623805.rgb.jpg/{w}x{h}bb.jpeg", "bgColor": "7f5516", "textColor1": "ffe2aa", "textColor2": "f8e0bd", "textColor3": "e5c58c", "textColor4": "e0c59c"}, "artistName": "Imagine Dragons", "url": "https://music.apple.com/us/album/warriors/1440831203?app=music\u0026at=1000l33QU\u0026i=1440831624\u0026mt=1", "discNumber": 1, "genreNames": ["Alternative", "Music"], "durationInMillis": 170799, "releaseDate": "2014-09-18", "name": "Warriors", "isrc": "USUM71414163", "albumName": "Smoke + Mirrors (Deluxe)", "playParams": {"id": "1440831624", "kind": "song"}, "trackNumber": 18, "composerName": "Imagine Dragons, Alex Da Kid \u0026 Josh Mosser"}, "spotify": {"album": {"album_type": "album", "artists": [{"external_urls": {"spotify": "https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"}, "href": "https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q", "id": "53XhwfbYqKCa1cC15pYq2q", "name": "Imagine Dragons", "type": "artist", "uri": "spotify:artist:53XhwfbYqKCa1cC15pYq2q"}], "available_markets": null, "external_urls": {"spotify": "https://open.spotify.com/album/6ecx4OFG0nlUMqAi9OXQER"}, "href": "https://api.spotify.com/v1/albums/6ecx4OFG0nlUMqAi9OXQER", "id": "6ecx4OFG0nlUMqAi9OXQER", "images": [{"height": 640, "url": "https://i.scdn.co/image/ab67616d0000b2731551c93dfa33ea4f30ef4eea", "width": 640}, {"height": 300, "url": "https://i.scdn.co/image/ab67616d00001e021551c93dfa33ea4f30ef4eea", "width": 300}, {"height": 64, "url": "https://i.scdn.co/image/ab67616d000048511551c93dfa33ea4f30ef4eea", "width": 64}], "name": "Smoke + Mirrors (Deluxe)", "release_date": "2015-10-30", "release_date_precision": "day", "total_tracks": 21, "type": "album", "uri": "spotify:album:6ecx4OFG0nlUMqAi9OXQER"}, "artists": [{"external_urls": {"spotify": "https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"}, "href": "https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q", "id": "53XhwfbYqKCa1cC15pYq2q", "name": "Imagine Dragons", "type": "artist", "uri": "spotify:artist:53XhwfbYqKCa1cC15pYq2q"}], "available_markets": null, "disc_number": 1, "duration_ms": 170066, "explicit": false, "external_ids": {"isrc": "USUM71414163"}, "external_urls": {"spotify": "https://open.spotify.com/track/1lgN0A2Vki2FTON5PYq42m"}, "href": "https://api.spotify.com/v1/tracks/1lgN0A2Vki2FTON5PYq42m", "id": "1lgN0A2Vki2FTON5PYq42m", "is_local": false, "name": "Warriors", "popularity": 68, "preview_url": "", "track_number": 18, "type": "track", "uri": "spotify:track:1lgN0A2Vki2FTON5PYq42m"}}}'  # noqa: E501

            assert find_audio('output.wav') == results

    def testfind_audio_fail(self):
        with patch('requests.post') as mock_request:
            mock_request.return_value.content = '{"status":"error","error":{"error_code":900,"error_message":"Recognition failed: authorization failed: wrong api_token."},"requested_params":{"url":"https://audd.tech/example1.mp3","return":"apple_music,spotify","method":"recognize"},"see api documentation":"https://docs.audd.io","contact us":"api@audd.io"}'  # noqa: E501
            assert find_audio('output.wav') == 'error'

    def test_print_audio_nice(self):

        null = None  # noqa: F841
        false = False  # noqa: F841
        results = eval('{"status":"success","result":{"artist":"Imagine Dragons","title":"Warriors","album":"Warriors","release_date":"2014-09-18","label":"Universal Music","timecode":"00:40","song_link":"https://lis.tn/Warriors","apple_music":{"previews":[{"url":"https://audio-ssl.itunes.apple.com/itunes-assets/AudioPreview118/v4/65/07/f5/6507f5c5-dba8-f2d5-d56b-39dbb62a5f60/mzaf_1124211745011045566.plus.aac.p.m4a"}],"artwork":{"width":1500,"height":1500,"url":"https://is2-ssl.mzstatic.com/image/thumb/Music128/v4/f4/78/f5/f478f58e-97cf-83b5-b5da-03d31f14e648/00602547623805.rgb.jpg/{w}x{h}bb.jpeg","bgColor":"7f5516","textColor1":"ffe2aa","textColor2":"f8e0bd","textColor3":"e5c58c","textColor4":"e0c59c"},"artistName":"Imagine Dragons","url":"https://music.apple.com/us/album/warriors/1440831203?app=music\u0026at=1000l33QU\u0026i=1440831624\u0026mt=1","discNumber":1,"genreNames":["Alternative","Music"],"durationInMillis":170799,"releaseDate":"2014-09-18","name":"Warriors","isrc":"USUM71414163","albumName":"Smoke + Mirrors (Deluxe)","playParams":{"id":"1440831624","kind":"song"},"trackNumber":18,"composerName":"Imagine Dragons, Alex Da Kid \u0026 Josh Mosser"},"spotify":{"album":{"album_type":"album","artists":[{"external_urls":{"spotify":"https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"},"href":"https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q","id":"53XhwfbYqKCa1cC15pYq2q","name":"Imagine Dragons","type":"artist","uri":"spotify:artist:53XhwfbYqKCa1cC15pYq2q"}],"available_markets":null,"external_urls":{"spotify":"https://open.spotify.com/album/6ecx4OFG0nlUMqAi9OXQER"},"href":"https://api.spotify.com/v1/albums/6ecx4OFG0nlUMqAi9OXQER","id":"6ecx4OFG0nlUMqAi9OXQER","images":[{"height":640,"url":"https://i.scdn.co/image/ab67616d0000b2731551c93dfa33ea4f30ef4eea","width":640},{"height":300,"url":"https://i.scdn.co/image/ab67616d00001e021551c93dfa33ea4f30ef4eea","width":300},{"height":64,"url":"https://i.scdn.co/image/ab67616d000048511551c93dfa33ea4f30ef4eea","width":64}],"name":"Smoke + Mirrors (Deluxe)","release_date":"2015-10-30","release_date_precision":"day","total_tracks":21,"type":"album","uri":"spotify:album:6ecx4OFG0nlUMqAi9OXQER"},"artists":[{"external_urls":{"spotify":"https://open.spotify.com/artist/53XhwfbYqKCa1cC15pYq2q"},"href":"https://api.spotify.com/v1/artists/53XhwfbYqKCa1cC15pYq2q","id":"53XhwfbYqKCa1cC15pYq2q","name":"Imagine Dragons","type":"artist","uri":"spotify:artist:53XhwfbYqKCa1cC15pYq2q"}],"available_markets":null,"disc_number":1,"duration_ms":170066,"explicit":false,"external_ids":{"isrc":"USUM71414163"},"external_urls":{"spotify":"https://open.spotify.com/track/1lgN0A2Vki2FTON5PYq42m"},"href":"https://api.spotify.com/v1/tracks/1lgN0A2Vki2FTON5PYq42m","id":"1lgN0A2Vki2FTON5PYq42m","is_local":false,"name":"Warriors","popularity":68,"preview_url":"","track_number":18,"type":"track","uri":"spotify:track:1lgN0A2Vki2FTON5PYq42m"}}}')  # noqa: E501
        assert print_audio_nice(
            results) == 'The song is Warriors by Imagine Dragons on the album Warriors'  # noqa: E501

    def test_print_audio_nice_fail(self):
        self.assertRaises(ValueError, print_audio_nice, 404)

    def test_print_audio_nice_fail2(self):
        self.assertRaises(ValueError, print_audio_nice, 'error')
